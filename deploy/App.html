<!DOCTYPE html>
<html>
<head>
    <title>project-permissions</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var app=null,topLevelProject="Salesforce Program";Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",items:{html:'<a href="https://help.rallydev.com/apps/2.0rc2/doc/">App SDK 2.0rc2 Docs</a>'},launch:function(){app=this,console.log("launch"),this.rows=[],this.exporter=Ext.create("GridExporter"),this.context=this.getContext(),this.addExportButton(),this.createGrid(),this.getObjects()},addExportButton:function(){var that=this,button=Ext.create("Rally.ui.Button",{text:"Export",handler:function(){that.exporter.exportGrid(that.grid)}});this.add(button)},getObjects:function(){myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),myMask.show(),this.workspace=this.getContext().getWorkspace(),console.log("worksapce",this.workspace);var that=this,configs=[];configs.push({model:"User",fetch:["UserName","Editors","LastLoginDate","SubscriptionAdmin","UserPermissions","NetworkID","FirstName","LastName","MiddleName","LastLoginDate"],filters:[{property:"UserName",operator:"contains",value:"@"},{property:"Disabled",operator:"=",value:!1}]}),configs.push({model:"Project",fetch:["ObjectID","Name","Parent","Description"],filters:[]}),async.map(configs,this.wsapiQuery,function(err,results){console.log("results",results),that.users=results[0],that.projects=results[1],async.map(that.users,that.loadUserPermissions,function(err,results){_.each(that.users,function(user,i){user.WorkspacePermissions=results[i]}),console.log("users:",that.users.length),that.processProjects()})})},processProjects:function(){var that=this;console.log("tree"),_.each(that.projects,function(project){if(null!==project.get("Parent")){var parent=_.find(that.projects,function(p){return p.get("ObjectID")===project.get("Parent").ObjectID});parent&&(_.isUndefined(parent.Children)&&(parent.Children=[]),parent.Children.push(project))}}),console.log("tree done!"),console.log("load editors"),async.map(that.projects,that.loadEditors,function(err,results){_.each(that.projects,function(project,i){project.Editors=results[i]}),console.log("load editors done!"),that.scanUsers()})},addToEditors:function(project,editors){_.each(project.Editors,function(editor){editors.push(editor.data.UserName)}),_.each(project.Children,function(child){app.addToEditors(child,editors)})},scanUsers:function(){var that=this,topLevel=_.find(that.projects,function(p){return p.get("Name")===topLevelProject}),projectEditors=_.map(topLevel.Children,function(child){var editors=[];return that.addToEditors(child,editors),editors=_.sortBy(_.uniq(editors)),{name:child.get("Name"),project:child,editors:editors}});console.log("project editors:",projectEditors),_.each(that.users,function(user){user.get("SubscriptionAdmin")===!1&&1==that.hasWorkspacePermissions(user)&&that.isWorkspaceAdmin(user)===!1&&(console.log("user:",user.get("UserName")),_.each(projectEditors,function(pe){-1!=pe.editors.indexOf(user.get("UserName"))&&(console.log(user.get("UserName"),pe.project.get("Name")),that.addRow(user,pe.project,!1))}))}),_.each(that.users,function(user){1!=that.hasWorkspacePermissions(user)||user.get("SubscriptionAdmin")!==!0&&that.isWorkspaceAdmin(user)!==!0||_.each(topLevel.Children,function(project){that.addRow(user,project,!0)})}),this.store.load(),myMask.hide()},isWorkspaceAdmin:function(user){var r=!1;return _.each(user.WorkspacePermissions,function(wsp){"Admin"==wsp.Role&&(r=!0)}),r},hasWorkspacePermissions:function(user){return user.WorkspacePermissions.length>0},recurseProjects:function(project,user){if(console.log("rp:",project,user),this.editorInProject(project,user))return!0;if(!_.isUndefined(project.Children))for(x=0;project.Children.length>x;x++)if(this.recurseProjects(project.Children[x],user))return!0;return!1},editorInProject:function(project,user){var r=!1;return _.each(project.Editors,function(editor){editor.get("_ref")===user.get("_ref")&&(r=!0)}),r},loadUserPermissions:function(user,callback){console.log("loading for user:",user.get("UserName"));var query='(User.UserName = "'+user.get("UserName")+'")';legacyUtils._runLegacyQuery(app.context,function(results){var workspacePermissions=_.filter(results.Results,function(wsp){return wsp.Workspace.ObjectID===app.workspace.ObjectID});callback(null,workspacePermissions)},"WorkspacePermission",query,"Workspace,Name,Role,ObjectID")},loadEditors:function(child,callback){child.getCollection("Editors").load({fetch:!0,callback:function(records,operation,success){callback(null,records)}})},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},createGrid:function(){this.store=Ext.create("Rally.data.custom.Store",{fields:[{name:"target",type:"string"},{name:"accountid",type:"string"},{name:"userid",type:"string"},{name:"usernamelast",type:"string"},{name:"usernamefirst",type:"string"},{name:"usernamemiddle",type:"string"},{name:"usernamesuffix",type:"string"},{name:"resourcetype",type:"string"},{name:"resourcename",type:"string"},{name:"resourcedesc",type:"string"},{name:"resourceattributename",type:"string"},{name:"resourceattributevalue",type:"string"},{name:"timelastaccess",type:"string"},{name:"timeextracted",type:"date"}],data:this.rows}),this.grid=Ext.create("Rally.ui.grid.Grid",{store:this.store,columnCfgs:[{text:"TARGET",dataIndex:"target"},{text:"ACCOUNT_ID",dataIndex:"accountid"},{text:"USER_ID",dataIndex:"userid"},{text:"USER_NAME_LAST",dataIndex:"usernamelast"},{text:"USER_NAME_FIRST",dataIndex:"usernamefirst"},{text:"USER_NAME_MIDDLE",dataIndex:"usernamemiddle"},{text:"USER_NAME_SUFFIX",dataIndex:"usernamesuffix"},{text:"RESOURCE_TYPE",dataIndex:"resourcetype"},{text:"RESOURCE_NAME",dataIndex:"resourcename"},{text:"RESOURCE_DESC",dataIndex:"resourcedesc"},{text:"RESOURCE_ATTRIBUTE_NAME",dataIndex:"resourceattributename"},{text:"RESOURCE_ATTRIBUTE_VALUE",dataIndex:"resourceattributevalue"},{text:"TIME_LAST_ACCESSED",dataIndex:"timelastaccess",renderer:Ext.util.Format.dateRenderer("m-d-Y")},{text:"TIME_EXTRACTED",dataIndex:"timeextracted",renderer:Ext.util.Format.dateRenderer("m-d-Y")}]}),this.add(this.grid)},addRow:function(user,project,admin){var lastLogin=null!==user.get("LastLoginDate")?Rally.util.DateTime.fromIsoString(user.get("LastLoginDate")):"None";console.log("last login:",lastLogin),this.rows.push({target:"Rally",accountid:user.get("UserName"),userid:user.get("NetworkID"),usernamelast:user.get("LastName"),usernamefirst:user.get("FirstName"),usernamemiddle:user.get("MiddleName"),usernamesuffix:"",resourcetype:"Role",resourcename:project.get("Name"),resourcedesc:project.get("Description"),resourceattributename:"Access Level",resourceattributevalue:admin===!0?"Admin":"Editor",timelastaccess:lastLogin,timeextracted:new Date})}});var legacyUtils={_runLegacyQuery:function(context,cb,typeName,query,fetch){var qr={Results:[]},count=-199,app=this,process=function(){count+=200,Ext.Ajax.request({method:"GET",url:"https://rally1.rallydev.com/slm/webservice/1.43/"+typeName+".js",params:{workspace:context.getWorkspace()._ref,project:context.getProject()._ref,projectScopeDown:!0,pagesize:200,start:count,fetch:fetch,query:query},success:function(res){res=JSON.parse(res.responseText),qr.Results=qr.Results.concat(res.QueryResult.Results),200>res.QueryResult.Results.length?cb(qr,app):process()}})};process()}};Ext.define("GridExporter",{dateFormat:"Y-m-d",exportGrid:function(grid){if(Ext.isIE)this._ieToExcel(grid);else{var data=this._getCSV(grid);window.location="data:text/csv;charset=utf8,"+encodeURIComponent(data)}},_escapeForCSV:function(string){return string.match(/,/)&&(string=string.match(/"/)?string.replace(/,/g,""):'"'+string+'"'),string},_getFieldText:function(fieldData){var text;return text=null==fieldData||void 0==fieldData?"":fieldData._refObjectName&&!fieldData.getMonth?fieldData._refObjectName:fieldData instanceof Date?Ext.Date.format(fieldData,this.dateFormat):fieldData.match?fieldData:""},_getFieldTextAndEscape:function(fieldData){var string=this._getFieldText(fieldData);return this._escapeForCSV(string)},_getCSV:function(grid){var cols=grid.columns,store=grid.store,data="";console.log("store",store);var that=this;return Ext.Array.each(cols,function(col,index){1!=col.hidden&&(data+=that._getFieldTextAndEscape(col.text)+",")}),data+="\n",_.each(store.proxy.data,function(record){Ext.Array.each(cols,function(col,index){if(1!=col.hidden){var fieldName=col.dataIndex,text=record[fieldName];data+=that._getFieldTextAndEscape(text)+","}}),data+="\n"}),data},_ieGetGridData:function(grid,sheet){var that=this,resourceItems=grid.store.data.items,cols=grid.columns;Ext.Array.each(cols,function(col,colIndex){1!=col.hidden&&(console.log("header: ",col.text),sheet.cells(1,colIndex+1).value=col.text)});var rowIndex=2;grid.store.each(function(record){var entry=record.getData();Ext.Array.each(cols,function(col,colIndex){if(1!=col.hidden){var fieldName=col.dataIndex,text=entry[fieldName],value=that._getFieldText(text);sheet.cells(rowIndex,colIndex+1).value=value}}),rowIndex++})},_ieToExcel:function(grid){if(window.ActiveXObject){var xlApp,xlBook;try{xlApp=new ActiveXObject("Excel.Application"),xlBook=xlApp.Workbooks.Add()}catch(e){return Ext.Msg.alert("Error",'For the export to work in IE, you have to enable a security setting called "Initialize and script ActiveX control not marked as safe" from Internet Options -> Security -> Custom level..."'),void 0}xlBook.worksheets("Sheet1").activate;var XlSheet=xlBook.activeSheet;xlApp.visible=!0,this._ieGetGridData(grid,XlSheet),XlSheet.columns.autofit}}});

            Rally.launchApp('CustomApp', {
                name:"project-permissions",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
